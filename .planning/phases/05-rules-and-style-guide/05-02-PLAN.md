---
phase: 05-rules-and-style-guide
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - .dsys/STYLE-GUIDE.md
  - CLAUDE.md
autonomous: true
requirements:
  - RULES-01
  - RULES-02
  - RULES-03
  - DOCS-01
  - DOCS-02

must_haves:
  truths:
    - "Running the rules agent against Luxora design-system.json produces a CLAUDE.md with section markers"
    - "Every rule in the generated CLAUDE.md is yes/no answerable"
    - "Rules reference token names (--color-primary, Color.dsActionPrimary) not hex values"
    - "Explicit NEVER prohibitions exist for colors, typography, spacing, radius, and components"
    - "Platform-specific sections appear for both React/Tailwind and SwiftUI (both platforms selected)"
    - "An aesthetic guard section exists with Luxora-specific anti-examples"
    - "STYLE-GUIDE.md contains color swatch tables with light/dark hex values"
    - "STYLE-GUIDE.md contains a typography table with Satoshi font family"
    - "STYLE-GUIDE.md contains a spacing scale table"
    - "A vibe narrative exists that describes the Luxora aesthetic without referencing benchmark names"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Design system enforcement rules"
      contains: "dsys:rules:start"
    - path: ".dsys/STYLE-GUIDE.md"
      provides: "Human-readable style guide"
      contains: "Spacing"
  key_links:
    - from: "CLAUDE.md"
      to: ".dsys/design-system.json"
      via: "Token names referenced in rules match semantic keys in JSON"
      pattern: "color-primary|dsActionPrimary"
    - from: ".dsys/STYLE-GUIDE.md"
      to: ".dsys/design-system.json"
      via: "Hex values in swatch tables match JSON values"
      pattern: "#1F3A1F|#4ADE80"
---

<objective>
Validate the rules agent by running it against the Luxora `design-system.json` with both platforms selected (`["react", "swiftui"]`). Inspect both output files (CLAUDE.md and `.dsys/STYLE-GUIDE.md`) for correctness, completeness, and requirement conformance.

Purpose: Same validation pattern as every prior phase — write the agent, then test it against real data to confirm it produces correct output.

Output: `CLAUDE.md` (with rules block), `.dsys/STYLE-GUIDE.md`
</objective>

<execution_context>
@/Users/james/.claude/get-shit-done/workflows/execute-plan.md
@/Users/james/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-rules-and-style-guide/05-CONTEXT.md
@.planning/phases/05-rules-and-style-guide/05-RESEARCH.md
@.planning/phases/05-rules-and-style-guide/05-01-SUMMARY.md
@skills/dsys/agents/rules.md
@.dsys/design-system.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute rules agent against Luxora design-system.json</name>
  <files>.dsys/STYLE-GUIDE.md, CLAUDE.md</files>
  <action>
Execute the rules agent prompt (`skills/dsys/agents/rules.md`) manually by following its numbered steps against the existing Luxora design-system.json.

**Parameters:**
- `design_system_path`: `.dsys/design-system.json`
- `claude_md_path`: `CLAUDE.md`
- `output_dir`: `.dsys/`
- `platforms`: `["react", "swiftui"]` (both platforms — since Phase 4 generated both)

Follow each step in rules.md sequentially:
1. Load and validate the design-system.json
2. Extract all token display data
3. Check for existing CLAUDE.md (should not exist in this project — create new)
4. Build the aesthetic guard section using Luxora's aesthetic data (bold, luxurious, editorial, forest-green)
5. Build all token rules with platform-specific sections for both React/Tailwind and SwiftUI
6. Build the vibe narrative from Luxora's aesthetic.summary, personality_tags, tone, density
7. Write CLAUDE.md with section markers
8. Build STYLE-GUIDE.md content with all sections
9. Write .dsys/STYLE-GUIDE.md
10. Run the agent's self-check
11. Return summary

The result should be two files with complete, Luxora-specific content.
  </action>
  <verify>
Verify CLAUDE.md:
1. File exists: `ls CLAUDE.md`
2. Section markers present: `grep "dsys:rules:start" CLAUDE.md` and `grep "dsys:rules:end" CLAUDE.md`
3. NEVER prohibitions: `grep -c "NEVER" CLAUDE.md` (expect 15+)
4. VIOLATION tests: `grep -c "VIOLATION" CLAUDE.md` (expect 10+)
5. Token names present: `grep "color-primary" CLAUDE.md` and `grep "dsActionPrimary" CLAUDE.md`
6. No raw hex as rule subjects: Confirm rules say "NEVER hardcode hex" not "NEVER use #1F3A1F" (hex may appear in examples)
7. React section: `grep "React" CLAUDE.md`
8. SwiftUI section: `grep "SwiftUI" CLAUDE.md`
9. Aesthetic guard: `grep "Aesthetic Guard" CLAUDE.md`
10. Vibe narrative present: `grep -c "personality\|aesthetic\|bold\|luxur" CLAUDE.md` (expect 3+)
11. No benchmark names: `grep -i "luxora" CLAUDE.md` should return 0 matches (the CLAUDE.md rules should not name the source benchmark — OR if meta.name is "Luxora" the design system name is acceptable, but source benchmark names are not)

Verify STYLE-GUIDE.md:
1. File exists: `ls .dsys/STYLE-GUIDE.md`
2. Color tables: `grep -c "|" .dsys/STYLE-GUIDE.md` (expect many table rows)
3. Hex values present: `grep "#1F3A1F" .dsys/STYLE-GUIDE.md` (Luxora primary)
4. Typography: `grep "Satoshi" .dsys/STYLE-GUIDE.md`
5. Spacing section: `grep -i "spacing" .dsys/STYLE-GUIDE.md`
6. Radius section: `grep -i "radius" .dsys/STYLE-GUIDE.md`
7. Vibe narrative: Check the opening section is 5-8 sentences
8. Platform columns: Both CSS and Swift token names should appear in tables
  </verify>
  <done>
Both output files exist and pass all verification checks:
- CLAUDE.md has section markers, NEVER prohibitions for all token categories, VIOLATION tests, platform-specific sections for both React and SwiftUI, and an aesthetic guard
- STYLE-GUIDE.md has color swatch tables with light/dark hex values, Satoshi typography table, spacing scale, border radius, and a vibe narrative
- No raw hex values used as the subject of prohibitions in rules (token names only)
- No source benchmark names in the vibe narrative
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify idempotent re-generation</name>
  <files>CLAUDE.md</files>
  <action>
Test the section-marker idempotency by re-running the CLAUDE.md write step. The second run should produce identical content, not doubled content.

1. Read the current CLAUDE.md and store its content
2. Re-execute the CLAUDE.md write step from rules.md (Step 7) — this time the file exists AND contains markers, so it should replace the existing block
3. Read the CLAUDE.md again
4. Compare: content should be identical to step 1 (or trivially different if the date stamp changes). The rules block should NOT be duplicated.

If content is doubled or markers are missing after re-run, fix the section-marker logic in rules.md.
  </action>
  <verify>
1. `grep -c "dsys:rules:start" CLAUDE.md` should return exactly 1
2. `grep -c "dsys:rules:end" CLAUDE.md` should return exactly 1
3. The file should not contain two `## Design System Rules` headings: `grep -c "## Design System Rules" CLAUDE.md` should return 1
  </verify>
  <done>
CLAUDE.md contains exactly one rules block after two runs. Section markers work correctly for idempotent regeneration.
  </done>
</task>

</tasks>

<verification>
- CLAUDE.md exists with section markers, platform-specific rule sections, aesthetic guard, vibe narrative, and NEVER prohibitions
- .dsys/STYLE-GUIDE.md exists with color tables, typography, spacing, radius, vibe narrative
- Re-running the write step produces identical output (idempotent)
- All 5 requirements (RULES-01..03, DOCS-01..02) verified through output inspection
- Every rule in CLAUDE.md can be answered with yes/no against a code snippet
</verification>

<success_criteria>
A fresh Claude session reading the generated CLAUDE.md would know: (1) what tokens to use and what to avoid for every category, (2) what components to use and what raw elements to avoid, (3) the aesthetic identity of the design system and what AI-generated defaults to resist, and (4) where to find the detailed style guide (.dsys/STYLE-GUIDE.md).
</success_criteria>

<output>
After completion, create `.planning/phases/05-rules-and-style-guide/05-02-SUMMARY.md`
</output>
