---
phase: 06-orchestrator-and-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/dsys/dsys/generate.md
  - skills/dsys/dsys/SKILL.md
autonomous: true
requirements:
  - ORCH-01
  - ORCH-05

must_haves:
  truths:
    - "User can invoke /dsys:generate with screenshot paths or a directory and the orchestrator responds"
    - "Orchestrator parses --name and --review flags from arguments"
    - "Orchestrator detects whether input is a directory or individual file paths"
    - "Orchestrator validates screenshot files exist before proceeding"
    - "Orchestrator prompts user for platform selection interactively"
    - "Orchestrator shows confirmation with screenshot count, platforms, project name, and overwrite warning"
    - "Analysis agents are issued in parallel (all Task calls in a single response turn)"
    - "Schema validation runs between analysis and synthesis, and between synthesis and generation"
    - "Partial analysis failure pauses and asks user whether to continue or abort"
    - "Stage banners display as each pipeline stage starts"
    - "Generator agents for both platforms run in parallel when both are selected"
    - "End-of-run summary shows file manifest and design system preview"
    - "Output is written to .dsys/<name>/ project directory structure"
  artifacts:
    - path: "skills/dsys/dsys/generate.md"
      provides: "Slash command entry point for /dsys:generate"
    - path: "skills/dsys/dsys/SKILL.md"
      provides: "Full orchestrator prompt with pipeline logic"
  key_links:
    - from: "skills/dsys/dsys/generate.md"
      to: "skills/dsys/dsys/SKILL.md"
      via: "@-include reference"
      pattern: "@skills/dsys/dsys/SKILL.md"
    - from: "skills/dsys/dsys/SKILL.md"
      to: "skills/dsys/agents/analyzer.md"
      via: "Task agent reference"
      pattern: "skills/dsys/agents/analyzer.md"
    - from: "skills/dsys/dsys/SKILL.md"
      to: "skills/dsys/agents/synthesizer.md"
      via: "Task agent reference"
      pattern: "skills/dsys/agents/synthesizer.md"
    - from: "skills/dsys/dsys/SKILL.md"
      to: "skills/dsys/agents/react-generator.md"
      via: "Task agent reference"
      pattern: "skills/dsys/agents/react-generator.md"
    - from: "skills/dsys/dsys/SKILL.md"
      to: "skills/dsys/agents/swiftui-generator.md"
      via: "Task agent reference"
      pattern: "skills/dsys/agents/swiftui-generator.md"
    - from: "skills/dsys/dsys/SKILL.md"
      to: "skills/dsys/agents/rules.md"
      via: "Task agent reference"
      pattern: "skills/dsys/agents/rules.md"
    - from: "skills/dsys/dsys/SKILL.md"
      to: "skills/dsys/schemas/analysis-findings.schema.json"
      via: "Bash npx ajv-cli validate"
      pattern: "analysis-findings.schema.json"
    - from: "skills/dsys/dsys/SKILL.md"
      to: "skills/dsys/schemas/design-system.schema.json"
      via: "Bash npx ajv-cli validate"
      pattern: "design-system.schema.json"
---

<objective>
Create the `/dsys:generate` slash command and its orchestrator prompt that wires all five existing agents (analyzer, synthesizer, react-generator, swiftui-generator, rules) into a single end-to-end pipeline.

Purpose: This is the capstone deliverable — the user-facing command that makes the entire dsys tool usable. Without this, the five agents exist but cannot be invoked together.

Output: Two files — `skills/dsys/dsys/generate.md` (thin command entry) and `skills/dsys/dsys/SKILL.md` (full orchestrator prompt).
</objective>

<execution_context>
@/Users/james/.claude/get-shit-done/workflows/execute-plan.md
@/Users/james/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-orchestrator-and-command/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generate.md slash command entry file</name>
  <files>skills/dsys/dsys/generate.md</files>
  <action>
Create the directory `skills/dsys/dsys/` and write `generate.md` — the thin slash command entry file for `/dsys:generate`.

**Frontmatter (exact fields):**
```yaml
---
name: dsys:generate
description: Generate a complete design system from screenshot benchmarks
argument-hint: "[screenshots...] [--name project-name] [--review]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Task
---
```

**Body:** A minimal prompt that:
1. States the objective: "Generate a complete design system from visual benchmark screenshots."
2. References SKILL.md via `@skills/dsys/dsys/SKILL.md` to load the orchestrator into context.
3. Passes `$ARGUMENTS` to the orchestrator.
4. Does NOT contain any orchestration logic — all logic lives in SKILL.md.

Keep this file under 25 lines total. The command file is a pass-through. Example structure from research:

```markdown
Generate a complete design system from visual benchmark screenshots.
Takes screenshot paths or a directory, analyzes them in parallel,
synthesizes design tokens, and generates platform-specific code.

@skills/dsys/dsys/SKILL.md

Arguments: $ARGUMENTS
```

**Do NOT:**
- Put any pipeline logic in this file
- Reference agent files directly (SKILL.md handles that)
- Add unnecessary explanatory text
  </action>
  <verify>
File exists at `skills/dsys/dsys/generate.md`. File has YAML frontmatter with `name: dsys:generate`. File contains `@skills/dsys/dsys/SKILL.md` reference. File contains `$ARGUMENTS`. File is under 25 lines.
  </verify>
  <done>
`/dsys:generate` command entry file exists with correct frontmatter and SKILL.md reference. It passes arguments through without containing pipeline logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SKILL.md orchestrator prompt</name>
  <files>skills/dsys/dsys/SKILL.md</files>
  <action>
Write `skills/dsys/dsys/SKILL.md` — the full orchestrator prompt. This is the core Phase 6 deliverable. Structure it as labeled sections that the orchestrating Claude instance follows sequentially. The orchestrator is a prompt, not code — it instructs Claude on what to do at each step.

**Structure the file with these sections, in order:**

### 1. Role and Overview
State: "You are the dsys orchestrator. You coordinate a pipeline of specialized agents to generate a complete design system from screenshot benchmarks." Explain what "complete" means: findings + design-system.json + platform files + CLAUDE.md + STYLE-GUIDE.md, all in `.dsys/<name>/`.

### 2. Arguments Parsing
Parse `$ARGUMENTS` into:
- `screenshot_inputs`: All positional arguments (file paths or a single directory path)
- `--name <value>`: Optional project name
- `--review`: Optional flag to pause after analysis

Instruct the orchestrator to:
1. Extract `--name <value>` if present, removing it from positional args
2. Extract `--review` flag if present, removing it from positional args
3. Remaining tokens are screenshot inputs

### 3. Screenshot Detection and Validation (use Bash tool)
Auto-detect whether input is a directory or individual paths:
- **Single arg that is a directory**: Use `ls` to enumerate `*.png *.jpg *.jpeg *.webp` (case-insensitive). Error if empty.
- **Multiple args / single file arg**: Treat each as a file path. Validate extension.

For each screenshot path:
- Convert to absolute path using Bash `realpath` (handles relative paths — Pitfall 3 from research)
- Validate the file exists using Bash `test -f`
- Collect valid paths and invalid paths separately

If zero valid screenshots: STOP and report error with list of invalid paths.

Display to user: "Found {N} screenshots: {basename1}, {basename2}, ..."

### 4. Project Name Resolution
If `--name` was provided: use it directly (lowercase, validate 3-30 chars, letters and hyphens only).

If not provided, auto-derive using this priority:
1. If all screenshots share a common parent directory AND the directory basename is meaningful (not "screenshots", "images", "benchmarks", "assets", "Desktop", "Downloads"): use the parent directory's basename, lowercased, non-alphanumeric replaced with hyphens.
2. If all screenshot filenames share a common prefix (at least 3 chars before any separator `-_`): use that prefix.
3. Fallback: `design-system-YYYY-MM-DD` using today's date.

Name format rules: lowercase, letters and hyphens only, 3-30 chars, trim leading/trailing hyphens.

### 5. Platform Selection (interactive prompt)
Ask the user: display a prompt like:

```
Which platforms should I generate?

1. React / Tailwind
2. SwiftUI
3. Both

Type 1, 2, or 3:
```

Wait for user response. Map to: `["react"]`, `["swiftui"]`, or `["react", "swiftui"]`.

### 6. Confirmation Step
Check if `.dsys/{name}/` already exists. Build confirmation message:

```
Ready to generate design system:

  Project: {name}
  Screenshots: {N} ({basename1}, {basename2}, ...)
  Platforms: {platform_list}
  Output: .dsys/{name}/
  {if exists: "⚠ Will overwrite existing output in .dsys/{name}/"}

Proceed? (yes/no)
```

Wait for user confirmation. If "no" or anything other than clear affirmative: abort.

### 7. Stage 1 — Parallel Analysis
Display banner: `## Analyzing {N} screenshots in parallel...`

Create output directory: `mkdir -p .dsys/{name}/findings/`

**CRITICAL INSTRUCTION — issue ALL analyzer Task calls in a SINGLE response. Do not issue one and wait for its result before issuing the next. All N Tasks must appear in the same response turn for parallel execution.**

For each validated screenshot path, issue a Task call:
```
Task(
  agent: "skills/dsys/agents/analyzer.md",
  prompt: "image_path: {absolute_path}\noutput_path: .dsys/{name}/findings/{basename_without_ext}.json"
)
```

After all Tasks complete, collect results. A result starting with `Error:` is a failure. Anything else is a success.

### 8. Analysis Results and Partial Failure Handling
Count successes and failures.

**If all failed:** STOP immediately. Display all error messages. Report that `.dsys/{name}/findings/` may contain partial output for debugging.

**If some failed but not all:** Display:
```
{fail_count} of {total} screenshots failed analysis:
  - {failed_basename}: {error_message}
  ...

{success_count} succeeded. Continue with successful results, or abort?
Type 'continue' or 'abort':
```
Wait for user response.

**If all succeeded:** Continue.

### 9. Schema Validation — Findings
For each successful findings JSON file, run:
```bash
npx ajv-cli validate --spec=draft2020 \
  -s skills/dsys/schemas/analysis-findings.schema.json \
  -d ".dsys/{name}/findings/{basename}.json" 2>&1
```

Check exit code. If validation fails for any file, treat it as an analysis failure (same as agent error). Apply partial failure logic from Step 8 again if needed.

### 10. Review Pause (conditional)
If `--review` flag was set:

Display:
```
## Analysis complete — review mode

{N} findings written to .dsys/{name}/findings/:
  - {path1}
  - {path2}
  ...

Review the findings files, then type 'proceed' to continue with synthesis.
```

Wait for user to reply "proceed" (or similar affirmative).

### 11. Stage 2 — Synthesis
Display banner: `## Synthesizing design tokens from {N} findings...`

Build the list of successful findings paths as a JSON array string.

Issue a single Task:
```
Task(
  agent: "skills/dsys/agents/synthesizer.md",
  prompt: "findings_paths: [{comma-separated quoted paths}]\noutput_path: .dsys/{name}/design-system.json"
)
```

If the result starts with `Error:`: STOP. Report the error. Note that findings persist in `.dsys/{name}/findings/` for debugging or re-run.

### 12. Schema Validation — Design System
Run:
```bash
npx ajv-cli validate --spec=draft2020 \
  -s skills/dsys/schemas/design-system.schema.json \
  -d ".dsys/{name}/design-system.json" 2>&1
```

If validation fails: STOP. Display the ajv error output. Report:
```
Schema validation failed for design-system.json.
Error: {first error from ajv output}
Intermediate files are in .dsys/{name}/ for debugging.
```

### 13. Stage 3 — Platform Generation
Display banner for each selected platform.

**If both platforms selected:** Issue BOTH generator Tasks in a single response turn (parallel):

React Task:
```
Task(
  agent: "skills/dsys/agents/react-generator.md",
  prompt: "design_system_path: .dsys/{name}/design-system.json\noutput_root: .dsys/{name}/react/src/design-system/\nplatforms: [\"react\"]"
)
```

SwiftUI Task:
```
Task(
  agent: "skills/dsys/agents/swiftui-generator.md",
  prompt: "design_system_path: .dsys/{name}/design-system.json\noutput_root: .dsys/{name}/swiftui/Sources/DesignSystem/\nplatforms: [\"swiftui\"]"
)
```

**If single platform:** Issue only the relevant Task.

Check each result for `Error:` prefix. If a generator fails: STOP and report. Note which platform failed and that `design-system.json` and findings persist.

### 14. Stage 4 — Rules and Style Guide
Display banner: `## Generating rules and style guide...`

Issue Task:
```
Task(
  agent: "skills/dsys/agents/rules.md",
  prompt: "design_system_path: .dsys/{name}/design-system.json\nclaude_md_path: .dsys/{name}/CLAUDE.md\noutput_dir: .dsys/{name}/\nplatforms: {platforms_json_array}"
)
```

**CRITICAL:** `claude_md_path` is `.dsys/{name}/CLAUDE.md`, NOT the project root `CLAUDE.md`. The user copies it manually when ready. This is a locked decision.

Check result for errors.

### 15. End-of-Run Summary
Read `.dsys/{name}/design-system.json` to extract preview values.

Display:

```
## dsys:generate complete — {name}

### Findings
  .dsys/{name}/findings/{file1}.json
  .dsys/{name}/findings/{file2}.json
  ...

### Design System
  .dsys/{name}/design-system.json

### React/Tailwind {if react selected}
  .dsys/{name}/react/src/design-system/tokens/tokens.css
  .dsys/{name}/react/src/design-system/tokens/tokens.json
  .dsys/{name}/react/src/design-system/tokens/theme.css
  ... {list all files}

### SwiftUI {if swiftui selected}
  .dsys/{name}/swiftui/Sources/DesignSystem/...
  ... {list all files}

### Documentation
  .dsys/{name}/CLAUDE.md
  .dsys/{name}/STYLE-GUIDE.md

---

### Design System Preview — {name}

Primary: {tokens.color.semantic.action.primary $value.light}
Surface: {tokens.color.semantic.surface.default $value.light}
Font: {tokens.typography.font_family.sans.$value}
Components: Button, Card, Input, Badge, Heading, Text

---

To integrate: copy `.dsys/{name}/CLAUDE.md` rules into your project's CLAUDE.md
```

Read the actual file listing from disk using `ls -R .dsys/{name}/` to show the real file manifest (not hardcoded paths).

Extract preview values by reading design-system.json and pulling:
- `tokens.color.semantic.action.primary.$value.light` for primary color
- `tokens.color.semantic.surface.default.$value.light` for surface color
- `tokens.typography.font_family.sans.$value` for font
- Count of component files in the generated platform directories

### Writing Style for SKILL.md
- Use numbered sections with clear headers (## Step N: Name)
- Use imperative instructions ("Do X", "Issue Y", "Display Z")
- Include literal examples of Task prompts so the orchestrator knows exact parameter formats
- Include literal examples of stage banners and user prompts
- Bold CRITICAL instructions (parallel execution, path handling, locked decisions)
- Keep each section self-contained so the orchestrator can resume from any point

**Do NOT:**
- Include the actual agent prompt content — just reference agent file paths
- Use @-references to agent files — pass file paths as Task agent parameters
- Hardcode hex color values in banners or summaries
- Auto-inject rules into project root CLAUDE.md
- Clean up files on failure
  </action>
  <verify>
File exists at `skills/dsys/dsys/SKILL.md`. File contains all 15 numbered sections. File references all 5 agent paths (analyzer.md, synthesizer.md, react-generator.md, swiftui-generator.md, rules.md). File references both schema paths (analysis-findings.schema.json, design-system.schema.json). File contains the parallel execution instruction ("ALL analyzer Task calls in a SINGLE response"). File contains `claude_md_path: .dsys/{name}/CLAUDE.md` (not project root). File contains the `--review` flag handling. File contains the partial failure prompt.
  </verify>
  <done>
SKILL.md orchestrator prompt exists with complete pipeline logic covering: argument parsing, screenshot validation, project naming, platform selection, confirmation, parallel analysis, schema validation gates, partial failure handling, synthesis, generation (with parallel both-platform support), rules generation, and end-of-run summary. All five agents are referenced by path. All locked decisions are honored.
  </done>
</task>

</tasks>

<verification>
1. `skills/dsys/dsys/generate.md` exists with correct YAML frontmatter (`name: dsys:generate`, `allowed-tools` includes Task)
2. `skills/dsys/dsys/SKILL.md` exists with all pipeline stages
3. SKILL.md references all 5 agent file paths correctly
4. SKILL.md references both JSON Schema file paths for validation
5. SKILL.md includes explicit parallel execution instruction for analyzer fan-out
6. SKILL.md includes explicit parallel execution instruction for dual-platform generation
7. SKILL.md writes CLAUDE.md to `.dsys/{name}/CLAUDE.md`, not project root
8. SKILL.md includes `--review` flag handling with pause point
9. SKILL.md includes partial failure handling with user prompt
10. SKILL.md includes end-of-run summary with file manifest and preview
11. generate.md references SKILL.md via `@` include and passes `$ARGUMENTS`
</verification>

<success_criteria>
Both files exist. The generate.md is a thin pass-through under 25 lines. SKILL.md contains the complete orchestrator logic for the full pipeline: argument parsing → screenshot validation → project naming → platform selection → confirmation → parallel analysis → schema validation → optional review pause → synthesis → schema validation → generation → rules → summary. All agent paths, schema paths, and locked decisions are correctly encoded.
</success_criteria>

<output>
After completion, create `.planning/phases/06-orchestrator-and-command/06-01-SUMMARY.md`
</output>
