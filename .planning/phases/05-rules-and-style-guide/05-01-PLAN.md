---
phase: 05-rules-and-style-guide
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/dsys/agents/rules.md
autonomous: true
requirements:
  - RULES-01
  - RULES-02
  - RULES-03
  - DOCS-01
  - DOCS-02

must_haves:
  truths:
    - "A rules agent prompt exists that reads design-system.json and produces both CLAUDE.md rules and STYLE-GUIDE.md"
    - "Every rule in the generated output is answerable with yes/no: does this code violate this rule?"
    - "Rules reference token names (--color-primary, Color.dsActionPrimary) not hex values (#1F3A1F)"
    - "Rules include explicit prohibitions (NEVER) for each token category: colors, typography, spacing, radius, components"
    - "Rules are organized into platform-conditional sections gated on the platforms input parameter"
    - "An aesthetic guard section exists that prevents AI-generated defaults from corrupting the design vibe"
    - "A vibe narrative template exists that draws from aesthetic.summary, personality_tags, tone, and density"
    - "Style guide includes color swatch tables, typography specimens, and spacing scale"
    - "CLAUDE.md management uses section markers for idempotent re-generation"
  artifacts:
    - path: "skills/dsys/agents/rules.md"
      provides: "Rules and style guide generation agent"
      min_lines: 400
  key_links:
    - from: "skills/dsys/agents/rules.md"
      to: ".dsys/design-system.json"
      via: "Read tool at runtime"
      pattern: "design_system_path"
    - from: "skills/dsys/agents/rules.md"
      to: "CLAUDE.md"
      via: "Write tool with section markers"
      pattern: "dsys:rules:start"
    - from: "skills/dsys/agents/rules.md"
      to: ".dsys/STYLE-GUIDE.md"
      via: "Write tool at runtime"
      pattern: "STYLE-GUIDE"
---

<objective>
Write the `rules.md` agent prompt that reads design-system.json and generates two output files: (1) a CLAUDE.md rules block with section markers for idempotent updates, and (2) `.dsys/STYLE-GUIDE.md` with color swatches, type specimens, spacing scale, and vibe narrative.

Purpose: This is the sole agent prompt for Phase 5. It follows the established agent anatomy (frontmatter, role, input, numbered steps, self-check, return summary) and embeds all rule templates, token name reference tables, section-marker algorithm, vibe narrative structure, and style guide table templates.

Output: `skills/dsys/agents/rules.md`
</objective>

<execution_context>
@/Users/james/.claude/get-shit-done/workflows/execute-plan.md
@/Users/james/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-rules-and-style-guide/05-CONTEXT.md
@.planning/phases/05-rules-and-style-guide/05-RESEARCH.md
@skills/dsys/agents/react-generator.md
@skills/dsys/agents/swiftui-generator.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write rules.md agent prompt</name>
  <files>skills/dsys/agents/rules.md</files>
  <action>
Create `skills/dsys/agents/rules.md` following the exact agent anatomy established by `react-generator.md` and `swiftui-generator.md`: YAML frontmatter, role section, input section, numbered steps, self-check, and return summary.

**Frontmatter:**
```yaml
---
name: dsys-rules-agent
description: Reads design-system.json and writes CLAUDE.md enforcement rules and .dsys/STYLE-GUIDE.md
tools: Read, Write
---
```

**Role section:** Explain this agent reads a validated design-system.json and produces two output files: a CLAUDE.md rules block (appended with section markers) and a human-readable style guide at `.dsys/STYLE-GUIDE.md`.

**Input section:** Three parameters from the orchestrator:
- `design_system_path`: Path to design-system.json. Default: `.dsys/design-system.json`
- `claude_md_path`: Path to CLAUDE.md. Default: `CLAUDE.md`
- `output_dir`: Directory for STYLE-GUIDE.md. Default: `.dsys/`
- `platforms`: Array of selected platforms (e.g., `["react", "swiftui"]`). Controls which platform-specific rule sections and token columns are emitted.

**Steps (numbered, following established pattern):**

**Step 1: Load and Validate Design System.**
Read `design_system_path`. Verify keys: `meta`, `tokens`, `aesthetic`, `platform_notes`. Within `tokens`, verify: `color.semantic`, `typography`, `spacing`, `border_radius`. If missing, STOP with actionable error. Same pattern as react-generator.md Step 1.

**Step 2: Extract Token Display Data.**
From the loaded JSON, extract:
- All semantic color token names and their light/dark hex values from `tokens.color.semantic`
- Typography values from `tokens.typography` (font family, weight scale, size scale, line-height scale)
- Spacing scale from `tokens.spacing`
- Border radius from `tokens.border_radius`
- Shadow data from `tokens.shadow` (may be null)
- Aesthetic data: `aesthetic.summary`, `aesthetic.personality_tags`, `aesthetic.tone`, `aesthetic.density`
- Meta: `meta.aesthetic_summary`, `meta.dominant_approach`, `meta.name`

The agent does NOT resolve hex values into token names — the JSON already has named semantic keys. The agent maps JSON paths to platform-specific token display names using the embedded reference tables.

**Step 3: Load Existing CLAUDE.md (Section-Marker Check).**
Attempt Read of `claude_md_path`. Three outcomes:
- File exists AND contains `<!-- dsys:rules:start -->`: Replace everything between start and end markers (inclusive of markers, re-emit new markers).
- File exists but NO markers: Append the entire rules block (with markers) to the end of the file.
- File does not exist: Write a new file containing only the rules block (with markers).

Store the existing content (or empty string) for Step 7.

**Step 4: Build Aesthetic Guard Section.**
Using `aesthetic.summary`, `aesthetic.personality_tags`, `aesthetic.tone`, `aesthetic.density`, and `meta.aesthetic_summary`, generate:

```markdown
### Aesthetic Guard

This design system has a specific aesthetic identity. These rules prevent AI-generated defaults from corrupting the visual character.

**This system is:** [1-2 sentences from aesthetic.summary and personality_tags]

**This system is NOT:**
- [anti-example 1 with concrete VIOLATION test]
- [anti-example 2 with concrete VIOLATION test]
- [anti-example 3 with concrete VIOLATION test]

[2-3 does-this-code VIOLATION test questions]
```

The anti-examples MUST be concrete and binary testable. They are derived by inverting the personality_tags and tone — if the system is "bold, luxurious, editorial" then the anti-examples target "playful, pastel, rounded, casual." Include specific CSS/Swift code patterns in VIOLATION tests. Use "WARNING" prefix (not "VIOLATION") for aesthetic guard rules per research recommendation — aesthetic violations require human judgment.

**Step 5: Build Token Rules Section.**
For each token category, emit rules with this anatomy:
```
- Use `[token name]` for [purpose]. NEVER [prohibited alternative].
  Does this code contain [grep-able pattern]? VIOLATION.
```

Categories to cover (all are mandatory):
1. **Colors** — All semantic roles from `tokens.color.semantic`. Platform-conditional columns:
   - React/Tailwind: CSS var (`--color-primary`) → Tailwind class (`bg-primary`, `text-primary`)
   - SwiftUI: Swift property (`Color.dsActionPrimary`)
   - Prohibition: NEVER hardcode hex values; NEVER use Tailwind default colors (gray-100, blue-500, etc.); NEVER use Color.blue / Color.black system colors
2. **Typography** — font family, font weight, font size. Prohibit raw font-family strings, arbitrary font sizes.
   - React: Use Tailwind type scale classes (`text-base`, `text-xl`). NEVER use `text-[14px]` arbitrary values.
   - SwiftUI: Use `DSFont` methods. NEVER use `Font.system()` or `Font.body` directly.
3. **Spacing** — Use design system spacing scale. Prohibit magic numbers.
   - React: Use spacing scale Tailwind classes (`p-4`, `gap-6`). Note: Tailwind spacing maps to the design system scale via theme.css.
   - SwiftUI: Use `DSSpacing()` properties. NEVER use `.padding(16)` with raw numbers.
4. **Border Radius** — Use design system radius tokens.
   - React: `rounded-sm`, `rounded-md`, `rounded-lg`. NEVER use `rounded-[8px]`.
   - SwiftUI: `DSRadius.sm`, `.md`, `.lg`. NEVER use `.cornerRadius(8)` with raw numbers.
5. **Shadows** — Use design system shadow tokens. Prohibit arbitrary shadows.
6. **Component Usage** — Use design system components. Platform-conditional:
   - React: Use `Button`, `Card`, `Input`, `Badge`, `Heading`, `Text` imported from the design system. NEVER use raw HTML `<button>`, `<input>` elements. Include import path guidance.
   - SwiftUI: Use `DSButton`, `DSCard`, `DSInput`, `DSBadge`, `DSHeading`, `DSText`. NEVER use raw `Button {}`, `TextField` directly.
7. **Dark Mode** — Platform-conditional:
   - React: Dark mode is handled by CSS custom properties. NEVER use `dark:bg-[#...]` arbitrary dark overrides.
   - SwiftUI: Dark mode is handled by asset catalog. NEVER use `@Environment(\.colorScheme)` to manually switch colors.

Each platform section is only emitted if that platform is in the `platforms` input array.

**Step 6: Build Vibe Narrative.**
Using aesthetic data from Step 2, compose a 5-8 sentence paragraph following this structure:
1. Open with dominant aesthetic identity (what this system IS)
2. Describe palette character (colors and emotional register)
3. Describe typography character (typeface personality, weight usage)
4. Describe spacing/density character
5. State explicit anti-examples (what this system is NOT — the critical AI guard)
6. Close with intended user/context fit

The narrative MUST NOT reference source benchmark names. It MUST include at least two concrete anti-examples. It MUST name the typeface and describe its emotional register. The audience is AI (Claude) — optimize for giving future sessions actionable aesthetic context. Do NOT use generic descriptors like "clean and modern" or "professional" — use the specific personality_tags from the design-system.json.

**Step 7: Write/Update CLAUDE.md.**
Assemble the full rules block:
```markdown
<!-- dsys:rules:start — generated by dsys on {date}, do not edit manually -->

## Design System Rules

{vibe narrative from Step 6 — placed first for immediate aesthetic context}

{aesthetic guard from Step 4}

### Token Rules

{token rules from Step 5, organized by platform}

<!-- dsys:rules:end -->
```

Apply the section-marker strategy from Step 3:
- If replacing: Substitute old markers+content with new block
- If appending: Add two blank lines then the full block
- If creating: Write the block as the entire file

Use the Write tool to save to `claude_md_path`.

**Step 8: Build STYLE-GUIDE.md Content.**
Assemble the style guide with these sections:

a. **Header** — Design system name (from `meta.name`), vibe narrative (from Step 6)
b. **Color Palette** — Two tables:
   - Primitive palette: table of all primitive colors from `tokens.color.primitive` with name, hex, and a usage note
   - Semantic colors grouped by category (Action, Surface, Text, Border, Feedback): table with Role, Token names (CSS and/or Swift, conditional on platforms), Light hex, Dark hex
c. **Typography** — Font family (with fallback stack), then type scale table: Step, Size (px), Rem, platform-conditional columns (Tailwind class, Swift method), Usage guidance column
d. **Spacing Scale** — Base unit, then table: Step, Value (px), Semantic Alias (from tokens.spacing semantic keys), Usage
e. **Border Radius** — Table: Step, Value, CSS/Swift token name
f. **Shadows** — Table: Level, Properties (blur, spread, offset, color), token names. If shadow is null, note "No shadow tokens defined."
g. **Component Reference** — Minimal table for each platform listing component name, variants, key props. Not rendered examples (impossible in Markdown). Only emitted for selected platforms.

All platform-specific columns are conditional on the `platforms` parameter.

**Step 9: Write STYLE-GUIDE.md.**
Write the assembled content to `{output_dir}/STYLE-GUIDE.md` using the Write tool.

**Step 10: Self-Check.**
Verify:
- CLAUDE.md was written and contains `<!-- dsys:rules:start -->` and `<!-- dsys:rules:end -->` markers
- Rules block contains "NEVER" prohibitions (at least 10 instances)
- Rules block does NOT contain raw hex values as the subject of prohibitions (hex may appear in VIOLATION test examples, but the rule itself must reference token names)
- Each platform section only appears if that platform is in `platforms`
- STYLE-GUIDE.md was written and contains all sections: colors, typography, spacing, radius
- Vibe narrative is 5-8 sentences
- Vibe narrative does NOT contain source benchmark names

If any check fails, go back and fix the issue before proceeding.

**Step 11: Return Summary.**
Return a structured summary listing files written, rule count, platform sections emitted, and any issues encountered.

**Embedded Reference Tables:**
The agent prompt MUST embed the complete token name reference tables verbatim (from the research document "Token Name Reference Table" section). This includes:
- React/Tailwind: all 18 `--color-*` → Tailwind class mappings
- SwiftUI: all 18 `Color.ds*` property names
- SwiftUI spacing: `DSSpacing()` property names
- SwiftUI radius: `DSRadius.*` constant names
- Component names for both platforms

These tables are embedded so the agent has zero external references at runtime — matching the self-contained pattern established by all prior agents.
  </action>
  <verify>
1. File exists: `ls skills/dsys/agents/rules.md`
2. File is substantial: `wc -l skills/dsys/agents/rules.md` (expect 400+ lines)
3. Agent anatomy: grep for frontmatter markers (`---`), `## Role`, `## Input`, `## Step 1`, `## Self-Check`
4. Section markers embedded: `grep "dsys:rules:start" skills/dsys/agents/rules.md`
5. Token reference tables embedded: `grep "dsActionPrimary" skills/dsys/agents/rules.md` and `grep "\-\-color-primary" skills/dsys/agents/rules.md`
6. Platforms parameter documented: `grep "platforms" skills/dsys/agents/rules.md`
7. NEVER prohibitions present: `grep -c "NEVER" skills/dsys/agents/rules.md` (expect 15+)
8. VIOLATION test patterns present: `grep -c "VIOLATION" skills/dsys/agents/rules.md` (expect 10+)
9. Aesthetic guard section exists: `grep "Aesthetic Guard" skills/dsys/agents/rules.md`
10. Vibe narrative instructions exist: `grep "personality_tags" skills/dsys/agents/rules.md`
11. No raw hex as rule subjects (hex only in examples): review the rule templates to confirm they reference token names, not specific hex values
  </verify>
  <done>
A complete `skills/dsys/agents/rules.md` agent prompt exists that:
- Follows the established agent anatomy (frontmatter, role, input, numbered steps, self-check, return summary)
- Reads design-system.json and produces both CLAUDE.md rules and STYLE-GUIDE.md
- Uses section markers for idempotent CLAUDE.md management
- Generates platform-conditional rule sections gated on the `platforms` parameter
- Every rule uses the imperative + token name + NEVER prohibition + VIOLATION test anatomy
- Includes an aesthetic guard section with concrete anti-examples
- Includes a vibe narrative template drawing from aesthetic JSON data
- Embeds all token name reference tables for self-contained runtime execution
  </done>
</task>

</tasks>

<verification>
- `skills/dsys/agents/rules.md` exists and is 400+ lines
- Agent follows same anatomy as `react-generator.md` and `swiftui-generator.md`
- All 5 requirements (RULES-01..03, DOCS-01..02) have corresponding agent steps
- Agent is self-contained (no external @-references at runtime)
- Section-marker algorithm is embedded
- Token reference tables are embedded
- Platform conditional logic is documented
</verification>

<success_criteria>
The rules agent prompt can be handed to Claude in a fresh session and, given a design-system.json path and platforms list, it will produce a complete CLAUDE.md rules block and STYLE-GUIDE.md without needing any other context files.
</success_criteria>

<output>
After completion, create `.planning/phases/05-rules-and-style-guide/05-01-SUMMARY.md`
</output>
