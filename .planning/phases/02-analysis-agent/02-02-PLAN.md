---
phase: 02-analysis-agent
plan: 02
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - skills/dsys/schemas/analysis-findings.schema.json
autonomous: false
requirements:
  - INPUT-01
  - INPUT-02
  - EXTRACT-01
  - EXTRACT-04
  - EXTRACT-05

must_haves:
  truths:
    - "The extended schema validates the Phase 1 worked examples without error (non-breaking addition)"
    - "A new example with rationale field passes schema validation"
    - "A new example with partial_failure + failed_categories passes schema validation (third allOf condition works)"
    - "The analyzer agent produces usable findings JSON when given a real screenshot (end-to-end test mandatory at checkpoint)"
    - "Error handling works: unsupported format and missing file produce actionable one-liner messages"
  artifacts:
    - path: "skills/dsys/schemas/analysis-findings.schema.json"
      provides: "Schema that validates both old (no rationale) and new (with rationale) documents"
    - path: ".dsys/findings/"
      provides: "At least one findings JSON file produced by the analyzer agent"
  key_links:
    - from: "skills/dsys/agents/analyzer.md"
      to: ".dsys/findings/*.json"
      via: "Agent writes findings to output_path"
      pattern: "Write tool"
    - from: ".dsys/findings/*.json"
      to: "skills/dsys/schemas/analysis-findings.schema.json"
      via: "Output validates against schema"
      pattern: "ajv.*validate"
---

<objective>
Validate the Phase 2 deliverables end-to-end: confirm the schema extension is non-breaking, run the analyzer agent against a real screenshot, and verify the output is schema-conformant.

Purpose: The analyzer agent prompt is the product of careful engineering, but vision extraction quality can only be verified empirically. This plan runs the agent against a real image and validates the full pipeline from image input to schema-conformant JSON output.

Output: Validated schema, at least one real findings JSON in `.dsys/findings/`, and user confirmation of extraction quality.
</objective>

<execution_context>
@/Users/james/.claude/get-shit-done/workflows/execute-plan.md
@/Users/james/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/02-analysis-agent/02-01-SUMMARY.md
@.planning/phases/02-analysis-agent/02-CONTEXT.md

@skills/dsys/agents/analyzer.md
@skills/dsys/schemas/analysis-findings.schema.json
@skills/dsys/references/analysis-findings-schema.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate schema extension and run analyzer agent</name>
  <files>
    skills/dsys/schemas/analysis-findings.schema.json
  </files>
  <action>
Perform three validation steps:

**Step A — Schema backward compatibility:**

Extract the two worked examples from `skills/dsys/references/analysis-findings-schema.md` (the SaaS dashboard and brand mood board examples). Write each to a temporary file and validate against the schema using ajv-cli:

```bash
npx ajv-cli validate \
  -s skills/dsys/schemas/analysis-findings.schema.json \
  -d /tmp/dsys-test-ui.json

npx ajv-cli validate \
  -s skills/dsys/schemas/analysis-findings.schema.json \
  -d /tmp/dsys-test-visual.json
```

Both must pass. If either fails, the schema extension broke backward compatibility — fix the schema before proceeding.

**Step B — Schema forward compatibility:**

Create a test document that includes the new `rationale` field. Take the SaaS dashboard example and add:
```json
"rationale": {
  "action_primary": "Purple-blue used on all interactive buttons and selected tab indicators",
  "surface_default": "Near-white background covering the main content area"
}
```

Validate this extended document against the schema. It must pass.

Also create a test document with `partial_failure: true` and `failed_categories: ["shadows"]` — validate it passes.

**Step B2 — Third allOf condition (partial_failure relaxation for ui_screenshot):**

Create a test document that is a `ui_screenshot` with `partial_failure: true`, `failed_categories: ["typography"]`, and `typography: null` (instead of an object). This tests the third `allOf` condition — without it, the schema would reject a `ui_screenshot` with null typography. Validate it passes.

Also create a NEGATIVE test: a `ui_screenshot` WITHOUT `partial_failure` and with `typography: null` — validate it FAILS. This confirms the second `allOf` constraint still applies when partial_failure is absent.

**Step C — Run the analyzer agent against a real screenshot:**

Find or create a screenshot to test with. Options in order of preference:
1. Check if any image files exist in the project: `find . -name "*.png" -o -name "*.jpg" -o -name "*.webp" | head -5`
2. If none exist, take a screenshot of a well-known website. Use the Read tool to read any available screenshot.
3. As a last resort, use one of the Phase 1 example images if referenced anywhere.

If an image is available, invoke the analyzer agent by following its instructions manually:
1. Read the image using the Read tool
2. Follow Steps 1-8 of the analyzer agent prompt exactly
3. Write the output to `.dsys/findings/test-validation.json`
4. Validate the output: `npx ajv-cli validate -s skills/dsys/schemas/analysis-findings.schema.json -d .dsys/findings/test-validation.json`

If NO image is available in the project, create `.dsys/findings/` directory and skip to the checkpoint — the user will provide a screenshot for testing.

**Step D — Error handling validation:**

Test the two error paths documented in the agent:
1. Attempt to read a file with unsupported extension (e.g., `test.bmp`) — verify the error message format matches "Error: Unsupported format: .bmp (use PNG, JPG, or WebP)"
2. Attempt to read a nonexistent file path — verify the error message format matches "Error: File not found or unreadable: {path}"

These are manual verification of the prompt instructions, not automated tests. Confirm the error message templates are present and correctly formatted in the agent prompt.

If schema validation (Steps A or B) fails, fix the schema in `analysis-findings.schema.json` before proceeding. Document what was fixed.
  </action>
  <verify>
All ajv-cli validations pass:
- Phase 1 SaaS dashboard example: valid
- Phase 1 brand mood board example: valid
- New example with rationale field: valid
- New example with partial_failure + failed_categories: valid
- ui_screenshot with partial_failure=true and typography=null: valid (third allOf works)
- ui_screenshot WITHOUT partial_failure and typography=null: INVALID (second allOf enforced)

If a real screenshot was available:
- `.dsys/findings/test-validation.json` exists and passes ajv validation
- The JSON contains plausible extracted values (not placeholder text)

Error message templates confirmed present in analyzer.md.
  </verify>
  <done>
Schema extension is confirmed non-breaking (Phase 1 examples still validate). New optional fields (rationale, partial_failure, failed_categories) are accepted by the schema. If a screenshot was available, the analyzer produced schema-conformant output. Error handling templates are correctly specified.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User review of analyzer agent and extraction quality</name>
  <action>
Present the analyzer agent and schema extension for user review. The user MUST provide a screenshot path for end-to-end testing. If Task 1 did not produce a validated findings JSON (e.g., no screenshot was found in the project), the checkpoint cannot be approved without first running the analyzer against a user-provided screenshot and validating the output against the schema.
  </action>
  <what-built>
Complete analysis agent: schema extension with rationale/partial_failure fields, analyzer agent prompt with embedded rubric and templates, and schema validation confirming backward compatibility.
  </what-built>
  <how-to-verify>
1. Review the analyzer agent prompt at `skills/dsys/agents/analyzer.md`:
   - Does it read clearly as a step-by-step guide for Claude?
   - Are the extraction rubric and fill-in templates embedded correctly?
   - Do the locked decisions (exact color preservation, decorative exclusion, error format) appear?

2. **REQUIRED: End-to-end screenshot test.** Provide a screenshot path so the analyzer can be run against it:
   - The executor will run the analyzer agent against your screenshot
   - The output findings JSON will be validated against the schema using ajv-cli
   - Review the findings JSON: are the extracted colors plausible? Typography identified? Spacing snapped to 4px grid?
   - Check the rationale strings: do they explain the reasoning for semantic assignments?

3. Review the schema changes at `skills/dsys/schemas/analysis-findings.schema.json`:
   - The `rationale`, `partial_failure`, and `failed_categories` fields should be present but NOT in the `required` array
   - The third `allOf` entry should permit null typography/spacing when `partial_failure` is true

4. If extraction quality is poor, note specific issues — they may require prompt adjustments in a gap closure plan.
  </how-to-verify>
  <verify>User has reviewed and responded with "approved" or specific feedback. A screenshot MUST have been tested end-to-end before approval.</verify>
  <done>User has approved the analyzer agent prompt and extraction quality after reviewing end-to-end results from a real screenshot, or provided actionable feedback for improvement</done>
  <resume-signal>Provide a screenshot path for end-to-end testing (e.g., "test with ~/screenshots/app.png"), then type "approved" after reviewing results — or describe issues with extraction quality or agent prompt</resume-signal>
</task>

</tasks>

<verification>
1. All six ajv-cli validation tests pass (two backward-compat, two forward-compat, one partial_failure relaxation positive, one negative)
2. End-to-end screenshot test completed: findings JSON exists in `.dsys/findings/` and passes validation (mandatory at checkpoint)
3. User has reviewed the analyzer agent prompt and confirmed it meets expectations
4. Error handling format is verified in the agent prompt
</verification>

<success_criteria>
- Schema extension is proven non-breaking via ajv-cli validation of Phase 1 examples
- New rationale and partial_failure fields are accepted by the schema
- Third allOf condition correctly relaxes ui_screenshot constraints when partial_failure is true
- User has reviewed and approved the analyzer agent prompt after end-to-end screenshot testing
- Output from a real screenshot is schema-conformant and extraction quality is acceptable
</success_criteria>

<output>
After completion, create `.planning/phases/02-analysis-agent/02-02-SUMMARY.md`
</output>
