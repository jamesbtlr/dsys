---
phase: 03-synthesizer-agent
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - .dsys/design-system.json
autonomous: true
requirements:
  - SYNTH-01
  - SYNTH-02
  - SYNTH-03
  - ORCH-03

must_haves:
  truths:
    - "The synthesizer agent produces a design-system.json that passes ajv-cli schema validation"
    - "Given the single Luxora test-validation.json finding, the synthesizer produces complete token output with all 18 semantic color roles populated"
    - "Derived tokens (surface.overlay, surface.inset, text.secondary, text.link) are present and reasonable"
    - "Feedback colors that were null in the single finding are derived with sensible defaults and logged in conflict_log"
    - "The aesthetic section reflects the Luxora benchmark's bold/comfortable/modern character"
    - "The design-system.json is written to disk and is human-inspectable"
  artifacts:
    - path: ".dsys/design-system.json"
      provides: "Schema-conformant design system synthesized from test finding"
      contains: "design-system"
  key_links:
    - from: ".dsys/design-system.json"
      to: "skills/dsys/schemas/design-system.schema.json"
      via: "Must pass ajv-cli validation with --spec=draft2020 flag"
      pattern: "meta.*tokens.*aesthetic"
    - from: ".dsys/design-system.json"
      to: ".dsys/findings/test-validation.json"
      via: "Synthesized from this input finding"
      pattern: "source_count.*1"
---

<objective>
Run the synthesizer agent end-to-end against the existing test-validation.json finding (Luxora mobile e-commerce app from Phase 2). Validate the output against design-system.schema.json using ajv-cli. Inspect the output for correctness: all 18 semantic roles populated, derived tokens present, aesthetic reflects the source, conflict_log appropriate for single-source input.

Purpose: Validates the synthesizer agent prompt works end-to-end, just as 02-02 validated the analyzer. This is the pass/fail gate for Phase 3: if the synthesizer produces schema-conformant, inspectable output from a real finding, the phase succeeds.

Output: `.dsys/design-system.json` — the first real design system output from the tool.
</objective>

<execution_context>
@/Users/james/.claude/get-shit-done/workflows/execute-plan.md
@/Users/james/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/03-synthesizer-agent/03-01-SUMMARY.md
@.planning/phases/03-synthesizer-agent/03-RESEARCH.md

@skills/dsys/agents/synthesizer.md
@skills/dsys/schemas/design-system.schema.json
@skills/dsys/references/token-schema.md
@.dsys/findings/test-validation.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run synthesizer agent and validate output</name>
  <files>
    .dsys/design-system.json
  </files>
  <action>
Execute the synthesizer agent manually by following each step in `skills/dsys/agents/synthesizer.md` against the single existing finding at `.dsys/findings/test-validation.json`.

**Input parameters for the agent:**
- `findings_paths`: [".dsys/findings/test-validation.json"]
- `output_path`: ".dsys/design-system.json"

**Follow the agent prompt step by step:**

1. **Load** the finding from `.dsys/findings/test-validation.json`. Verify it parses as valid JSON.

2. **Source Validation Pass**: This is a single finding, so it is automatically the dominant benchmark. Count: 1 ui_screenshot, 0 visual_references. Confidence: high. No voting needed — all values come from this single source.

3. **Semantic Color Merge**: With N=1, there are no conflicts to resolve. Each non-null semantic assignment maps directly to the output. For null assignments (action_secondary, action_secondary_dark, action_destructive, action_destructive_dark, feedback_success, feedback_warning, feedback_info), derive sensible defaults:
   - action_secondary: use a lighter/muted version of the surface palette (gray-200 light / gray-700 dark typical)
   - action_destructive: standard red (#EF4444 light / #F87171 dark)
   - feedback_success: standard green (#22C55E light / #4ADE80 dark)
   - feedback_warning: standard amber (#F59E0B light / #FACC15 dark)
   - feedback_info: use action_primary color (#1F3A1F light / #4ADE80 dark) or a blue
   Log each derived value in conflict_log with rationale "Derived — no benchmark contained this role"

4. **Derive missing output tokens** not in findings:
   - surface.overlay: white light / dark gray dark
   - surface.inset: slightly darker than surface.default light / slightly lighter than surface.default dark
   - text.secondary: midpoint between text.primary and text.muted
   - text.link: same as action.primary

5. **Primitive Color Build**: Use the Luxora palette (8 colors). Add derived colors that aren't in the palette (red for destructive, green for success, amber for warning).

6. **Typography Merge**: Map Luxora's observed values:
   - sans: "Satoshi" with fallback stack
   - mono: null (not observed)
   - display: null (not observed)
   - Scale: Map [12, 13, 14, 16, 20, 24, 40, 48] to standard keys. Snap to standard type scale.
   - Weights: 400, 500, 600, 700
   - Line height: "tight" → 1.25

7. **Spacing Merge**: base_unit=4, density=comfortable. Produce all 13 scale steps. Assign semantic spacing for comfortable density.

8. **Non-Color Tokens**:
   - Shadow: Convert the single sm shadow from findings format to DTCG format (offset_x=0 → "0px", offset_y=2 → "2px", blur=8 → "8px", spread=0 → "0px", color #000000 opacity 0.06 → "#0000000F" 8-digit hex). Since only sm is observed, produce sm only (or supplement with standard md/lg/xl if the prompt says to include tiers from any source — follow the agent's instructions exactly).
   - Border radius: sm=8→"8px", md=16→"16px", lg=24→"24px", full=true→"9999px"
   - Opacity: [0.3, 0.5] → disabled=0.3, overlay=0.5. Derive subtle and heavy if the agent prompt instructs it.

9. **Aesthetic Pass**: Single source — use Luxora's aesthetic directly: tone=bold, density=comfortable, personality_tags from the finding's 6 tags (may need to add 1-2 for minimum of 4 — already has 6 which is in range).

10. **Platform Notes**: Generate standard platform notes per the prompt.

11. **Fill Template**: Fill the complete design-system.json template with all values from above.

12. **Write** to `.dsys/design-system.json`.

**Then validate:**
```bash
npx ajv-cli validate -s skills/dsys/schemas/design-system.schema.json -d .dsys/design-system.json --spec=draft2020
```
This MUST pass. If it fails, read the error, fix the JSON, and re-validate. Common failures:
- Missing required field → add it
- Pattern mismatch on hex → fix to #RRGGBB format
- Dimension pattern mismatch → ensure "Npx" format
- conflict_log candidates minItems:2 → derived tokens logged with candidates [] won't satisfy this; check if the prompt handles single-source derived tokens differently from multi-source conflicts

**Inspect the output for quality:**
- All 18 semantic color roles should be non-null
- surface.overlay, surface.inset, text.secondary, text.link must be present
- The color palette should feel consistent with the Luxora green/white/pink brand
- Typography should reference Satoshi
- Spacing should be 4px grid, comfortable density
- conflict_log should contain entries for derived tokens (null feedback colors, derived overlay/inset/secondary/link)
  </action>
  <verify>
Schema validation passes: `npx ajv-cli validate -s skills/dsys/schemas/design-system.schema.json -d .dsys/design-system.json --spec=draft2020` exits with success.

Content checks:
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('source_count:', d['meta']['source_count'])"` prints `source_count: 1`
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('semantic keys:', len(d['tokens']['color']['semantic']))"` confirms 6 semantic groups (action, surface, text, border, feedback, $type)
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('has overlay:', 'overlay' in d['tokens']['color']['semantic']['surface'])"` prints True
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('has text.link:', 'link' in d['tokens']['color']['semantic']['text'])"` prints True
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('has text.secondary:', 'secondary' in d['tokens']['color']['semantic']['text'])"` prints True
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('spacing steps:', len(d['tokens']['spacing']['scale']) - 1)"` prints 13 (13 scale steps + $type key - 1 = 13)
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('tone:', d['aesthetic']['tone'])"` prints `bold`
- `python3 -c "import json; d=json.load(open('.dsys/design-system.json')); print('font:', d['tokens']['typography']['font_family']['sans']['$value'])"` prints `Satoshi`
  </verify>
  <done>
`.dsys/design-system.json` exists, passes ajv-cli schema validation with --spec=draft2020, contains all 18 semantic color roles populated (including derived overlay/inset/secondary/link), has appropriate conflict_log entries for derived tokens, reflects the Luxora aesthetic (bold tone, comfortable density, Satoshi font, forest-green palette), and is human-inspectable on disk.
  </done>
</task>

</tasks>

<verification>
1. `.dsys/design-system.json` exists and is valid JSON
2. `npx ajv-cli validate -s skills/dsys/schemas/design-system.schema.json -d .dsys/design-system.json --spec=draft2020` passes
3. All 18 semantic color roles are present with non-null $value and $description
4. Derived tokens (surface.overlay, surface.inset, text.secondary, text.link) are present
5. conflict_log contains entries for derived/defaulted tokens (feedback_success, feedback_warning, feedback_info, action_secondary, action_destructive)
6. aesthetic.tone = "bold", aesthetic.density = "comfortable" (matching source)
7. typography.font_family.sans.$value = "Satoshi"
8. spacing.base_unit = 4, all 13 scale steps present
9. platform_notes.react and platform_notes.swiftui are non-empty strings
10. meta.source_count = 1, meta.source_types.ui_screenshots = 1
</verification>

<success_criteria>
- The synthesizer produces a design-system.json from a single real finding that passes full schema validation
- All required output tokens are populated, including those derived from context rather than directly observed
- The output is human-inspectable: a developer reading design-system.json can see the complete design system with meaningful descriptions
- The conflict_log documents every synthesis decision where values were derived (not directly observed)
- The aesthetic identity reflects the source benchmark, not a generic default
</success_criteria>

<output>
After completion, create `.planning/phases/03-synthesizer-agent/03-02-SUMMARY.md`
</output>
